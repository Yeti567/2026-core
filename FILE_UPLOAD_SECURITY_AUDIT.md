# File Upload Security Audit Report

## Executive Summary

**Status:** âš ï¸ **NEEDS IMPROVEMENT** - Several critical security issues found

**Total Upload Routes:** 6 routes
**Routes with Complete Validation:** 3 âœ…
**Routes Missing Validation:** 1 âŒ
**Routes with Partial Validation:** 2 âš ï¸

---

## Critical Security Issues

### ðŸ”´ CRITICAL - Missing File Type & Size Validation

#### 1. `app/api/documents/[id]/upload/route.ts`
**Issues:**
- âŒ **NO file type validation** - Accepts any file type
- âŒ **NO file size limit** - Could accept unlimited file sizes (DoS risk)
- âš ï¸ **Uses sanitized user filename** - Relies on regex sanitization (line 71)

**Risk:** HIGH
- Could upload executable files (.exe, .sh, .php)
- Could cause DoS with large files
- Path traversal risk if sanitization fails

**Current Code:**
```typescript
const file = formData.get('file') as File | null;
// NO VALIDATION HERE!
const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
const filePath = `${profile.company_id}/${documentId}/${versionId}/${timestamp}_${safeName}`;
```

---

### ðŸŸ¡ HIGH RISK - Filename Security Issues

#### 2. `app/api/certifications/[id]/upload/route.ts` (Line 87)
**Issue:** Uses extension from user-provided filename
```typescript
const fileExt = file.name.split('.').pop()?.toLowerCase() || 'bin';
const fileName = `${profile.company_id}/${certification.worker_id}/${id}.${fileExt}`;
```

**Risk:** MEDIUM
- Extension could be manipulated (e.g., `file.php.jpg`)
- Should derive extension from MIME type, not filename

#### 3. `app/api/maintenance/upload-receipt/route.ts` (Line 80)
**Issue:** Uses sanitized user filename in path
```typescript
const sanitizedName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
const filePath = `maintenance/${equipmentId}/${timestamp}_${sanitizedName}`;
```

**Risk:** MEDIUM
- Path traversal if sanitization fails
- Should use generated UUID filename

#### 4. `app/api/pdf-converter/upload/route.ts` (Line 58)
**Issue:** Uses sanitized user filename
```typescript
const sanitizedName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
const storagePath = `pdf-forms/${profile.company_id}/${timestamp}_${sanitizedName}`;
```

**Risk:** LOW (has type validation, but filename still user-controlled)

---

## Security Analysis by Route

### âœ… SECURE Routes

#### 1. `app/api/documents/upload/route.ts`
- âœ… File type validation: PDF only
- âœ… File size limit: 50MB
- âœ… Secure filename: Generated by `processUploadedDocument()`
- âœ… Rate limiting: 10 uploads/minute
- âœ… Authentication: Required
- âœ… Permissions: Role-based

#### 2. `app/api/certifications/upload/route.ts`
- âœ… File type validation: Images + PDF
- âœ… File size limit: 10MB
- âœ… Secure filename: Generated UUID-based
- âœ… Rate limiting: 10 uploads/minute
- âœ… Authentication: Required
- âœ… Permissions: Role-based

#### 3. `app/api/documents/bulk-upload/route.ts`
- âœ… File type validation: PDF, DOCX, XLSX, PPTX, TXT
- âœ… File size limit: 25MB per file
- âœ… Secure filename: Generated by `processUploadedDocument()`
- âœ… Rate limiting: Yes
- âœ… Authentication: Required
- âœ… Permissions: Role-based

### âš ï¸ PARTIALLY SECURE Routes

#### 4. `app/api/maintenance/upload-receipt/route.ts`
- âœ… File type validation: Images + PDF
- âœ… File size limit: 10MB
- âš ï¸ **Filename:** Uses sanitized user filename (should use UUID)
- âœ… Authentication: Required
- âœ… Permissions: Role-based

#### 5. `app/api/pdf-converter/upload/route.ts`
- âœ… File type validation: PDF only
- âœ… File size limit: 50MB
- âš ï¸ **Filename:** Uses sanitized user filename (should use UUID)
- âœ… Authentication: Required
- âœ… Permissions: Role-based

### âŒ INSECURE Routes

#### 6. `app/api/documents/[id]/upload/route.ts`
- âŒ **NO file type validation**
- âŒ **NO file size limit**
- âš ï¸ **Filename:** Uses sanitized user filename
- âœ… Authentication: Required
- âœ… Permissions: Role-based

---

## Additional Security Concerns

### 1. MIME Type Spoofing
**Issue:** All routes rely on `file.type` which can be spoofed by clients

**Risk:** MEDIUM
- Client can send `file.type = 'application/pdf'` but upload `.exe` file
- Should validate file content (magic bytes) in addition to MIME type

**Current Pattern:**
```typescript
if (file.type !== 'application/pdf') {
  return error;
}
```

**Recommended:**
```typescript
// Validate MIME type
if (file.type !== 'application/pdf') return error;

// Validate file content (magic bytes)
const buffer = await file.arrayBuffer();
const header = new Uint8Array(buffer.slice(0, 4));
const pdfHeader = [0x25, 0x50, 0x44, 0x46]; // %PDF
if (!header.every((byte, i) => byte === pdfHeader[i])) {
  return error;
}
```

### 2. Storage RLS Policies
**Status:** Need to verify Supabase Storage buckets have RLS enabled

**Recommendation:** Verify storage bucket policies:
```sql
-- Check storage policies
SELECT * FROM storage.buckets;
SELECT * FROM storage.objects LIMIT 1;
```

### 3. File Content Scanning
**Missing:** No virus/malware scanning

**Recommendation:** Consider adding:
- Virus scanning for uploaded files
- Content validation (e.g., PDF structure validation)
- File content analysis

---

## Recommendations

### ðŸ”´ CRITICAL - Fix Immediately

1. **Fix `app/api/documents/[id]/upload/route.ts`**
   - Add file type validation
   - Add file size limit
   - Use generated UUID filename

2. **Improve Filename Security**
   - Replace all user-provided filenames with UUID-based names
   - Store original filename separately in database
   - Derive extension from MIME type, not filename

### ðŸŸ¡ HIGH PRIORITY

3. **Add Content Validation**
   - Validate file magic bytes in addition to MIME type
   - Prevent MIME type spoofing attacks

4. **Standardize File Upload Security**
   - Create shared file upload validation utility
   - Consistent validation across all routes

### ðŸŸ¢ MEDIUM PRIORITY

5. **Add File Content Scanning**
   - Virus scanning (if budget allows)
   - PDF structure validation
   - Image validation

6. **Verify Storage Security**
   - Confirm RLS policies on storage buckets
   - Review storage bucket permissions

---

## Secure File Upload Pattern

### Recommended Implementation

```typescript
import { z } from 'zod';
import { randomUUID } from 'crypto';

const ALLOWED_TYPES = {
  'application/pdf': { extension: 'pdf', maxSize: 50 * 1024 * 1024 },
  'image/jpeg': { extension: 'jpg', maxSize: 10 * 1024 * 1024 },
  'image/png': { extension: 'png', maxSize: 10 * 1024 * 1024 },
};

const fileUploadSchema = z.object({
  file: z.instanceof(File).refine(
    (file) => Object.keys(ALLOWED_TYPES).includes(file.type),
    'Invalid file type'
  ).refine(
    (file) => {
      const config = ALLOWED_TYPES[file.type as keyof typeof ALLOWED_TYPES];
      return file.size <= config.maxSize;
    },
    'File too large'
  ),
});

export async function POST(request: Request) {
  const formData = await request.formData();
  const file = formData.get('file') as File;
  
  // Validate with Zod
  const validation = fileUploadSchema.safeParse({ file });
  if (!validation.success) {
    return NextResponse.json(
      { error: 'Validation failed', details: validation.error.errors },
      { status: 400 }
    );
  }
  
  // Validate file content (magic bytes)
  const buffer = await file.arrayBuffer();
  if (!validateFileContent(buffer, file.type)) {
    return NextResponse.json({ error: 'File content does not match type' }, { status: 400 });
  }
  
  // Generate secure filename
  const config = ALLOWED_TYPES[file.type as keyof typeof ALLOWED_TYPES];
  const filename = `${randomUUID()}.${config.extension}`;
  const filePath = `${companyId}/${folderId}/${filename}`;
  
  // Upload to storage
  await supabase.storage.from('bucket').upload(filePath, buffer, {
    contentType: file.type,
    upsert: false,
  });
}
```

---

## Summary

### Current State
- âœ… Most routes have basic validation
- âœ… Authentication and permissions are good
- âŒ One route completely missing validation
- âš ï¸ Filename security needs improvement
- âš ï¸ MIME type validation can be spoofed

### Action Items
1. **Fix critical route** (`documents/[id]/upload`) - URGENT
2. **Improve filename security** - HIGH
3. **Add content validation** - HIGH
4. **Create shared validation utility** - MEDIUM
5. **Verify storage RLS** - MEDIUM

---

*Report generated: $(date)*
*Routes analyzed: 6*
*Critical issues: 1*
*High priority issues: 3*
